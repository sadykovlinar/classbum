<script>
document.addEventListener("DOMContentLoaded", () => {
  // üîó —Ç–≤–æ–π –±–µ–∫–µ–Ω–¥
  const API_BASE = "https://8bc38b36-e4c1-4423-9883-dae5cf8ca105-00-3amdfj7gt49q3.riker.replit.dev";

  const STORAGE_KEY = "classbum_auth";

  // --- helpers localStorage ---
  function saveAuth(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadAuth() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }

  function clearAuth() {
    localStorage.removeItem(STORAGE_KEY);
  }

  // --- –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤ ---
  function showLK(child) {
    const regBlock = document.getElementById("cb-register-block");
    const loginBlock = document.getElementById("cb-login-block");
    const lkBlock = document.getElementById("cb-lk-block");
    if (!regBlock || !loginBlock || !lkBlock) return;

    regBlock.style.display = "none";
    loginBlock.style.display = "none";
    lkBlock.style.display = "block";

    document.getElementById("cb-lk-firstname").textContent = child.first_name || "";
    document.getElementById("cb-lk-lastname").textContent = child.last_name || "";
    document.getElementById("cb-lk-login").textContent = child.login || "";
    document.getElementById("cb-lk-publicid").textContent = child.public_id || "";
    document.getElementById("cb-lk-class").textContent = child.class ?? "-";
  }

  function showAuth() {
    const regBlock = document.getElementById("cb-register-block");
    const loginBlock = document.getElementById("cb-login-block");
    const lkBlock = document.getElementById("cb-lk-block");
    if (!regBlock || !loginBlock || !lkBlock) return;

    regBlock.style.display = "block";
    loginBlock.style.display = "block";
    lkBlock.style.display = "none";
  }

  // --- —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ API ---
  async function api(url, method = "GET", body = null, withAuth = false) {
    const headers = { "Content-Type": "application/json" };

    if (withAuth) {
      const saved = loadAuth();
      if (saved?.token) {
        headers["Authorization"] = "Bearer " + saved.token;
      }
    }

    const res = await fetch(API_BASE + url, {
      method,
      headers,
      body: body ? JSON.stringify(body) : null,
    });

    return res.json();
  }

  // --- –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Å—Å–∏–π –≤ –õ–ö ---
  function renderSessions(sessions) {
    const container = document.getElementById("cb-lk-sessions");
    if (!container) {
      console.warn("–ù–µ—Ç –±–ª–æ–∫–∞ #cb-lk-sessions ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ –ø–æ–∫–∞–∂–µ—Ç—Å—è");
      return;
    }

    if (!sessions || sessions.length === 0) {
      container.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ—à—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞—á ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Ç—Ä–µ–Ω–∞–∂—ë—Ä—É!";
      return;
    }

    const last = sessions[0];

    let tasksArr = [];
    if (Array.isArray(last.tasks)) {
      tasksArr = last.tasks;
    } else if (typeof last.tasks === "string") {
      try { tasksArr = JSON.parse(last.tasks); } catch (e) {}
    }

    const totalTasks = tasksArr.length || 0;
    const minutes = last.total_time_ms ? Math.round(last.total_time_ms / 60000) : 0;

    container.innerHTML = `
      <div><strong>–í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π:</strong> ${sessions.length}</div>
      <div><strong>–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–µ—Å—Å–∏—è:</strong> ${new Date(last.created_at).toLocaleString()}</div>
      <div><strong>–†–µ–∂–∏–º:</strong> ${last.mode || "‚Äî"}</div>
      <div><strong>–ó–∞–¥–∞—á –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–µ—Å—Å–∏–∏:</strong> ${totalTasks}</div>
      <div><strong>–û—à–∏–±–æ–∫:</strong> ${last.total_wrong ?? 0}</div>
      <div><strong>–ü–æ–¥—Å–∫–∞–∑–æ–∫:</strong> ${last.total_hints ?? 0}</div>
      <div><strong>–í—Ä–µ–º—è:</strong> ${minutes} –º–∏–Ω.</div>
    `;
  }

  async function loadMySessions() {
    try {
      const data = await api("/api/children/my-sessions", "GET", null, true);
      if (!data.ok) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏–∏:", data.error);
        return;
      }
      renderSessions(data.sessions || []);
    } catch (e) {
      console.error("loadMySessions error:", e);
    }
  }

  // --- —ç–ª–µ–º–µ–Ω—Ç—ã ---
  const btnRegister = document.getElementById("cb-register-btn");
  const btnLogin = document.getElementById("cb-login-btn");
  const btnLogout = document.getElementById("cb-logout-btn");
  const regMsg = document.getElementById("cb-reg-message");
  const loginMsg = document.getElementById("cb-login-message");
  const sessionsBlock = document.getElementById("cb-lk-sessions");

  if (!btnRegister || !btnLogin || !btnLogout) {
    console.error("–ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –∫–∞–±–∏–Ω–µ—Ç–∞ (–ø—Ä–æ–≤–µ—Ä—å id)");
    return;
  }

  // --- —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ---
  btnRegister.addEventListener("click", async () => {
    const login = document.getElementById("cb-reg-login").value.trim();
    const password = document.getElementById("cb-reg-password").value.trim();
    const first_name = document.getElementById("cb-reg-firstname").value.trim();
    const last_name = document.getElementById("cb-reg-lastname").value.trim();
    const schoolClass = document.getElementById("cb-reg-class").value.trim();

    regMsg.textContent = "";

    if (!login || !password || !first_name || !last_name) {
      regMsg.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω, –ø–∞—Ä–æ–ª—å, –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é";
      return;
    }

    try {
      const data = await api("/api/children/register", "POST", {
        login,
        password,
        first_name,
        last_name,
        class: schoolClass,
      });

      if (!data.ok) {
        if (data.error === "login_taken") {
          regMsg.textContent = "–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç";
        } else if (data.error === "fill_required_fields") {
          regMsg.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è";
        } else {
          regMsg.textContent = "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏";
        }
        return;
      }

      saveAuth({ token: data.token, child: data.child });
      showLK(data.child);
      // ‚¨á –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ–±—ë–Ω–∫–∞ (–ø–æ–∫–∞ –ø—É—Å—Ç–æ, –Ω–æ –ª–æ–≥–∏–∫–∞ –æ–¥–Ω–∞)
      loadMySessions();
    } catch (e) {
      console.error(e);
      regMsg.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
    }
  });

  // --- –≤—Ö–æ–¥ ---
  btnLogin.addEventListener("click", async () => {
    const login = document.getElementById("cb-login-login").value.trim();
    const password = document.getElementById("cb-login-password").value.trim();

    loginMsg.textContent = "";

    if (!login || !password) {
      loginMsg.textContent = "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å";
      return;
    }

    try {
      const data = await api("/api/children/login", "POST", { login, password });

      if (!data.ok) {
        if (data.error === "user_not_found" || data.error === "wrong_password") {
          loginMsg.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å";
        } else {
          loginMsg.textContent = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
        }
        return;
      }

      saveAuth({ token: data.token, child: data.child });
      showLK(data.child);
      loadMySessions();
    } catch (e) {
      console.error(e);
      loginMsg.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
    }
  });

  // --- –≤—ã—Ö–æ–¥ ---
  btnLogout.addEventListener("click", () => {
    clearAuth();
    if (sessionsBlock) sessionsBlock.textContent = "";
    showAuth();
  });

  // --- –∞–≤—Ç–æ-–≤—Ö–æ–¥ ---
  (async () => {
    const saved = loadAuth();
    if (!saved?.token) return;

    try {
      const me = await api("/api/children/me", "GET", null, true);
      if (me.ok) {
        saveAuth({ token: saved.token, child: me.child });
        showLK(me.child);
        loadMySessions();
      } else {
        clearAuth();
        showAuth();
      }
    } catch (e) {
      console.error(e);
      clearAuth();
      showAuth();
    }
  })();
});
</script>
